<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SEVENTEEN í¬ì¹´ ì²´ì»¤</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#ffffff;--bg2:#f5f5f5;--surface:#efefef;--surface2:#e8e8e8;--border:#d0d0d0;--text:#111111;--text2:#666666;--text3:#999999;}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'Nanum Gothic',sans-serif;min-height:100vh;}

  /* Header */
  header{background:var(--bg);border-bottom:2px solid var(--text);padding:0 24px;position:sticky;top:0;z-index:200;}
  .header-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:64px;gap:16px;}
  .logo{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:4px;color:var(--text);white-space:nowrap;display:flex;align-items:baseline;gap:10px;}
  .logo-sub{font-family:'Nanum Gothic',sans-serif;font-size:0.65rem;font-weight:800;letter-spacing:3px;color:var(--text2);}
  .header-btns{display:flex;gap:8px;flex-wrap:wrap;}

  /* Stats */
  .stats-bar{background:var(--text);color:var(--bg);padding:10px 24px;}
  .stats-inner{max-width:1200px;margin:0 auto;display:flex;gap:24px;align-items:center;flex-wrap:wrap;}
  .stat-item{display:flex;align-items:baseline;gap:6px;font-size:0.78rem;color:rgba(255,255,255,.6);}
  .stat-num{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;color:#fff;letter-spacing:1px;}
  .stat-slash{color:rgba(255,255,255,.3);font-size:1.1rem;margin:0 2px;}
  .stat-total-num{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:rgba(255,255,255,.5);}
  .progress-wrap{flex:1;min-width:160px;display:flex;align-items:center;gap:10px;}
  .progress-bar{flex:1;height:4px;background:rgba(255,255,255,.2);border-radius:2px;overflow:hidden;}
  .progress-fill{height:100%;background:#fff;border-radius:2px;transition:width .4s ease;}
  .progress-pct{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:#fff;min-width:44px;}

  /* Toolbar */
  .toolbar{background:var(--bg2);border-bottom:1px solid var(--border);padding:12px 24px;}
  .toolbar-inner{max-width:1200px;margin:0 auto;display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
  .search-wrap{position:relative;flex:1;min-width:180px;max-width:280px;}
  .search-wrap svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:14px;height:14px;stroke:var(--text3);fill:none;stroke-width:2;pointer-events:none;}
  .search-input{width:100%;padding:7px 10px 7px 32px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.8rem;font-family:'Nanum Gothic',sans-serif;outline:none;transition:border-color .2s;}
  .search-input:focus{border-color:var(--text);}
  .search-input::placeholder{color:var(--text3);}
  .filter-sep{width:1px;height:24px;background:var(--border);}
  .filter-label{font-size:0.72rem;color:var(--text2);white-space:nowrap;}
  .filter-group{display:flex;gap:5px;flex-wrap:wrap;}
  .fbtn{padding:5px 13px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:0.73rem;cursor:pointer;transition:all .15s;font-family:'Nanum Gothic',sans-serif;font-weight:700;letter-spacing:.5px;}
  .fbtn:hover{border-color:var(--text);color:var(--text);}
  .fbtn.active{background:var(--text);border-color:var(--text);color:#fff;}
  .fbtn.danger:hover{border-color:#111;background:#111;color:#fff;}

  /* Main */
  .main{max-width:1200px;margin:0 auto;padding:24px;}

  /* Album */
  .album-section{margin-bottom:36px;}
  .album-header{display:flex;align-items:center;gap:10px;margin-bottom:14px;padding-bottom:12px;border-bottom:2px solid var(--text);flex-wrap:wrap;}
  .album-title{font-family:'Bebas Neue',sans-serif;font-size:1.15rem;letter-spacing:2px;color:var(--text);}
  .album-badge{font-size:0.65rem;font-weight:800;letter-spacing:1px;border:1px solid var(--border);padding:2px 8px;border-radius:3px;color:var(--text2);}
  .album-count{margin-left:auto;font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:1px;color:var(--text2);}
  .album-count strong{color:var(--text);}
  .al-btn{background:none;border:1px solid var(--border);border-radius:4px;color:var(--text2);font-size:0.68rem;padding:3px 9px;cursor:pointer;font-family:'Nanum Gothic',sans-serif;font-weight:700;transition:all .15s;}
  .al-btn:hover{border-color:var(--text);color:var(--text);}
  .al-btn.del:hover{background:#111;border-color:#111;color:#fff;}

  /* Card grid */
  .card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(105px,1fr));gap:10px;}

  /* Poca card */
  .poca-card{aspect-ratio:2/3;border-radius:6px;border:1.5px solid var(--border);cursor:pointer;position:relative;overflow:hidden;transition:all .2s;background:var(--surface);display:flex;flex-direction:column;align-items:center;justify-content:flex-end;user-select:none;}
  .poca-card:hover{transform:translateY(-3px);border-color:var(--text);box-shadow:0 6px 20px rgba(0,0,0,.12);}
  .poca-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:5px;filter:grayscale(100%) brightness(.85);transition:filter .35s ease;}
  .poca-card.have .poca-img{filter:grayscale(0%) brightness(1);}
  .poca-card.have{border-color:#111;background:#f0f0f0;}
  .poca-overlay{position:absolute;inset:0;border-radius:5px;background:linear-gradient(to top,rgba(0,0,0,.75) 35%,transparent 70%);}
  .poca-card:not(.have) .poca-overlay{background:linear-gradient(to top,rgba(0,0,0,.82) 35%,rgba(0,0,0,.25) 100%);}
  .poca-text{position:relative;z-index:1;text-align:center;padding:0 5px 7px;width:100%;}
  .poca-member{font-size:0.7rem;font-weight:800;line-height:1.3;color:#fff;}
  .poca-version{font-size:0.58rem;color:rgba(255,255,255,.65);line-height:1.2;margin-top:1px;}
  .poca-text-only{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;height:100%;padding:6px;}
  .poca-text-only .poca-member{color:var(--text);}
  .poca-text-only .poca-version{color:var(--text2);}
  .poca-check{position:absolute;top:6px;right:6px;z-index:2;width:20px;height:20px;border-radius:50%;background:#111;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s;}
  .poca-check svg{width:11px;height:11px;stroke:#fff;fill:none;stroke-width:2.5;}
  .poca-card.have .poca-check{opacity:1;}

  /* Context menu */
  .ctx-menu{position:fixed;background:#fff;border:1.5px solid #111;border-radius:6px;overflow:hidden;z-index:500;min-width:160px;box-shadow:4px 4px 0 #111;display:none;}
  .ctx-menu.show{display:block;animation:popIn .12s ease;}
  @keyframes popIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
  .ctx-title{padding:9px 14px 7px;font-size:0.72rem;color:var(--text2);border-bottom:1px solid var(--border);font-weight:800;}
  .ctx-item{padding:10px 14px;cursor:pointer;font-size:0.82rem;display:flex;align-items:center;gap:8px;transition:background .1s;}
  .ctx-item:hover{background:var(--surface);}
  .ctx-item.cur{font-weight:800;background:var(--surface2);}

  /* Modals */
  .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:800;display:none;align-items:center;justify-content:center;padding:20px;}
  .modal-bg.show{display:flex;}
  .modal{background:#fff;border:2px solid #111;border-radius:8px;box-shadow:6px 6px 0 #111;padding:28px;width:100%;max-width:500px;max-height:84vh;overflow-y:auto;}
  .modal h2{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:2px;color:var(--text);margin-bottom:18px;}
  .modal label{font-size:0.78rem;color:var(--text2);display:block;margin-bottom:4px;font-weight:800;}
  .modal input{width:100%;padding:9px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:0.85rem;font-family:'Nanum Gothic',sans-serif;margin-bottom:13px;outline:none;transition:border-color .15s;}
  .modal input:focus{border-color:var(--text);}
  .modal-btns{display:flex;gap:8px;margin-top:10px;justify-content:flex-end;}
  .tag-list{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:13px;}
  .tag{padding:3px 10px;border:1px solid var(--border);border-radius:3px;font-size:0.75rem;color:var(--text2);display:flex;align-items:center;gap:5px;background:var(--surface);}
  .tag button{background:none;border:none;color:var(--text);cursor:pointer;font-size:1rem;line-height:1;}
  .photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-bottom:12px;}
  .photo-item{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:9px;}
  .photo-item label{font-size:0.67rem;color:var(--text2);margin-bottom:4px;}
  .photo-item input{font-size:0.7rem;padding:4px 8px;margin-bottom:0;}

  /* Backup modal */
  .backup-section{margin-bottom:24px;}
  .backup-section h3{font-size:0.75rem;font-weight:800;letter-spacing:1px;text-transform:uppercase;border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:12px;}
  .info-box{font-size:0.8rem;color:var(--text2);line-height:1.9;padding:13px 15px;background:var(--surface);border:1px solid var(--border);border-radius:6px;margin-bottom:0;}
  .info-box strong{color:var(--text);}
  .info-box .tag-pill{display:inline-block;background:var(--text);color:#fff;font-size:0.68rem;font-weight:800;padding:1px 7px;border-radius:3px;vertical-align:middle;}
  .last-backup-row{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;margin-bottom:12px;font-size:0.8rem;}
  .last-backup-row span{color:var(--text2);}
  .last-backup-row strong{color:var(--text);font-size:0.88rem;}

  /* Toast */
  .toast{position:fixed;bottom:24px;right:24px;z-index:900;background:#111;color:#fff;padding:11px 20px;border-radius:6px;font-size:0.8rem;font-weight:700;box-shadow:3px 3px 0 rgba(0,0,0,.15);opacity:0;transform:translateY(8px);transition:opacity .25s,transform .25s;pointer-events:none;display:flex;align-items:center;gap:8px;}
  .toast.show{opacity:1;transform:translateY(0);}
  .toast-icon{font-size:1rem;}

  .empty{text-align:center;padding:56px;color:var(--text2);font-size:0.9rem;line-height:2.2;}
  ::-webkit-scrollbar{width:5px;}
  ::-webkit-scrollbar-track{background:var(--bg);}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

  @media(max-width:600px){
    .card-grid{grid-template-columns:repeat(auto-fill,minmax(82px,1fr));gap:7px;}
    .logo{font-size:1.3rem;}
    .stats-inner{gap:14px;}
  }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo">SVT <span class="logo-sub">POCA CHECKER</span></div>
    <div class="header-btns">
      <button class="fbtn" id="btn-add-album">+ ì•¨ë²” ì¶”ê°€</button>
      <button class="fbtn" id="btn-backup-modal">ğŸ—‚ ë°±ì—…</button>
      <button class="fbtn danger" id="btn-reset">ì´ˆê¸°í™”</button>
    </div>
  </div>
</header>

<div class="stats-bar">
  <div class="stats-inner">
    <div class="stat-item">
      ì†Œì¥
      <span class="stat-num" id="sn-have">0</span>
      <span class="stat-slash">/</span>
      <span class="stat-total-num" id="sn-total">0</span>
    </div>
    <div class="progress-wrap">
      <div class="progress-bar"><div class="progress-fill" id="prog-fill" style="width:0%"></div></div>
      <div class="progress-pct" id="prog-pct">0%</div>
    </div>
  </div>
</div>

<div class="toolbar">
  <div class="toolbar-inner">
    <div class="search-wrap">
      <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="22" y2="22"/></svg>
      <input type="text" class="search-input" id="search-input" placeholder="ë©¤ë²„Â·ë²„ì „ ê²€ìƒ‰...">
    </div>
    <div class="filter-sep"></div>
    <span class="filter-label">ë©¤ë²„</span>
    <div class="filter-group" id="member-filters"></div>
    <div class="filter-sep"></div>
    <span class="filter-label">ìƒíƒœ</span>
    <div class="filter-group">
      <button class="fbtn active" data-status="all">ì „ì²´</button>
      <button class="fbtn" data-status="have">ì†Œì¥</button>
      <button class="fbtn" data-status="not">ë¯¸ì†Œì¥</button>
    </div>
  </div>
</div>

<div class="main" id="main"></div>

<!-- Context menu -->
<div class="ctx-menu" id="ctx-menu">
  <div class="ctx-title" id="ctx-title">í¬ì¹´</div>
  <div class="ctx-item" data-action="have">âœ“ ì†Œì¥</div>
  <div class="ctx-item" data-action="not">âœ• ë¯¸ì†Œì¥</div>
</div>

<!-- Modal: Add Album -->
<div class="modal-bg" id="modal-album">
  <div class="modal">
    <h2>ì•¨ë²” ì¶”ê°€</h2>
    <label>ì•¨ë²”ëª… *</label>
    <input type="text" id="al-name" placeholder="ì˜ˆ) Face the Sun">
    <label>íƒ€ì…</label>
    <input type="text" id="al-type" placeholder="ì˜ˆ) ì •ê·œ 4ì§‘">
    <label>ë²„ì „ ì…ë ¥ í›„ Enter â†µ</label>
    <input type="text" id="al-ver-input" placeholder="ì˜ˆ) ep.1 Circle">
    <div class="tag-list" id="al-ver-tags"></div>
    <p style="font-size:.75rem;color:var(--text2);margin-bottom:10px">ğŸ’¡ ì €ì¥ í›„ ğŸ“· ì‚¬ì§„ í¸ì§‘ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”</p>
    <div class="modal-btns">
      <button class="fbtn" id="modal-al-cancel">ì·¨ì†Œ</button>
      <button class="fbtn active" id="modal-al-save">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Modal: Edit photos -->
<div class="modal-bg" id="modal-photos">
  <div class="modal">
    <h2>ğŸ“· ì‚¬ì§„ í¸ì§‘</h2>
    <p style="font-size:.78rem;color:var(--text2);margin-bottom:14px">ì†Œì¥ í¬ì¹´ëŠ” ì»¬ëŸ¬ë¡œ, ë¯¸ì†Œì¥ì€ í‘ë°±ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
    <div id="photo-edit-grid" class="photo-grid"></div>
    <div class="modal-btns">
      <button class="fbtn" id="photo-cancel">ì·¨ì†Œ</button>
      <button class="fbtn active" id="photo-save">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Modal: Backup -->
<div class="modal-bg" id="modal-backup">
  <div class="modal" style="max-width:480px">
    <h2>ğŸ—‚ ë°±ì—… & ë³µì›</h2>

    <!-- Auto backup info -->
    <div class="backup-section">
      <h3>ìë™ ë°±ì—…</h3>
      <div class="info-box">
        ì•±ì„ <strong>ì—´ ë•Œë§ˆë‹¤</strong> í˜„ì¬ ë°ì´í„°ê°€ <span class="tag-pill">JSON</span> íŒŒì¼ë¡œ ìë™ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.<br>
        íŒŒì¼ëª…: <strong>svt-poca-YYYYMMDD-HHmm.json</strong><br>
        ë‹¤ìš´ë¡œë“œ í´ë”ì— ë‚ ì§œë³„ë¡œ ìŒ“ì´ë¯€ë¡œ ì–¸ì œë“  ê³¼ê±° ì‹œì ìœ¼ë¡œ ë³µì›í•  ìˆ˜ ìˆì–´ìš”.
      </div>
    </div>

    <!-- Last backup -->
    <div class="backup-section">
      <h3>ë§ˆì§€ë§‰ ë°±ì—…</h3>
      <div class="last-backup-row">
        <span>ì´ë²ˆ ì„¸ì…˜ ë°±ì—…</span>
        <strong id="last-backup-label">â€”</strong>
      </div>
      <button class="fbtn active" id="btn-manual-export" style="width:100%;justify-content:center;display:flex">â¬‡ ì§€ê¸ˆ ë°”ë¡œ JSON ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <!-- Restore -->
    <div class="backup-section">
      <h3>ë³µì›</h3>
      <div class="info-box" style="margin-bottom:10px">ë°±ì—…ëœ JSON íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ë©´ í•´ë‹¹ ì‹œì ìœ¼ë¡œ ë³µì›ë©ë‹ˆë‹¤.<br><strong>í˜„ì¬ ë°ì´í„°ëŠ” ë³µì› ì „ì— ë¨¼ì € ë°±ì—…ë©ë‹ˆë‹¤.</strong></div>
      <label class="fbtn" style="cursor:pointer;display:inline-flex;align-items:center;gap:6px;margin:0">
        â¬† JSON íŒŒì¼ë¡œ ë³µì›
        <input type="file" id="import-file" accept=".json" style="display:none">
      </label>
    </div>

    <div class="modal-btns">
      <button class="fbtn" id="backup-close">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"><span class="toast-icon" id="toast-icon"></span><span id="toast-msg"></span></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MEMBERS=['ì—ìŠ¤ì¿±ìŠ¤','ì •í•œ','ì¡°ìŠˆì•„','ì¤€','í˜¸ì‹œ','ì›ìš°','ìš°ì§€','ë””ì—ì‡','ë¯¼ê·œ','ë„ê²¸','ìŠ¹ê´€','ë²„ë…¼','ë””ë…¸'];
const K_ALBUMS='svt_albums_v4', K_STATE='svt_state_v4', K_PHOTOS='svt_photos_v4';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function lsGet(k,d){try{const v=localStorage.getItem(k);return v!=null?JSON.parse(v):d;}catch(e){return d;}}
function lsSet(k,v){localStorage.setItem(k,JSON.stringify(v));}

let albums=lsGet(K_ALBUMS,[]);
let state =lsGet(K_STATE,{});
let photos=lsGet(K_PHOTOS,{});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pid(alId,m,vi){return `${alId}__${m}__v${vi}`;}
function allPocas(al){
  const out=[];
  MEMBERS.forEach(m=>al.versions.forEach((ver,vi)=>out.push({id:pid(al.id,m,vi),member:m,version:ver,versionIdx:vi})));
  return out;
}
function getStatus(id){return state[id]?.status||'not';}
function setStatus(id,st){if(!state[id])state[id]={status:'not'};state[id].status=st;lsSet(K_STATE,state);}
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function fmtDate(d){const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}.${p(d.getMonth()+1)}.${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;}
function fileStamp(d){const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}`;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BACKUP â€” JSON ë‹¤ìš´ë¡œë“œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastBackupLabel = 'â€”';

function exportJSON(silent=false){
  if(!albums.length && !Object.keys(state).length) return; // ë¹ˆ ë°ì´í„°ëŠ” ê±´ë„ˆëœ€

  const now  = new Date();
  const data = {
    albums,
    state,
    photos,
    exportedAt: now.toISOString(),
    have: countHave(),
    total: countTotal()
  };

  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `svt-poca-${fileStamp(now)}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  lastBackupLabel = fmtDate(now);
  const el = document.getElementById('last-backup-label');
  if(el) el.textContent = lastBackupLabel;

  if(!silent) showToast('â¬‡','JSON ë°±ì—… ì™„ë£Œ');
}

function countHave(){let n=0;albums.forEach(al=>allPocas(al).forEach(p=>{if(getStatus(p.id)==='have')n++;}));return n;}
function countTotal(){let n=0;albums.forEach(al=>n+=allPocas(al).length);return n;}

// â”€â”€ Import JSON â”€â”€
function importJSON(file){
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      if(!data.albums){showToast('âš ','ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');return;}
      if(!confirm('ì´ íŒŒì¼ë¡œ ë³µì›í• ê¹Œìš”?\ní˜„ì¬ ë°ì´í„°ë¥¼ ë¨¼ì € ë°±ì—…í•œ ë’¤ ë³µì›í•©ë‹ˆë‹¤.')){return;}
      exportJSON(true); // í˜„ì¬ ìƒíƒœ ë¨¼ì € ë°±ì—…
      albums=data.albums||[];
      state =data.state||{};
      photos=data.photos||{};
      lsSet(K_ALBUMS,albums);lsSet(K_STATE,state);lsSet(K_PHOTOS,photos);
      renderAll();
      document.getElementById('modal-backup').classList.remove('show');
      showToast('âœ“','ë³µì› ì™„ë£Œ');
    }catch(err){showToast('âš ','íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: '+err.message);}
  };
  reader.readAsText(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(icon,msg){
  const t=document.getElementById('toast');
  document.getElementById('toast-icon').textContent=icon;
  document.getElementById('toast-msg').textContent=msg;
  t.classList.add('show');
  clearTimeout(t._t);
  t._t=setTimeout(()=>t.classList.remove('show'),2400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let filterMember='all',filterStatus='all',filterSearch='';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){renderMemberFilters();renderMain();updateStats();}

function renderMemberFilters(){
  const wrap=document.getElementById('member-filters');
  wrap.innerHTML='';
  const mk=(label,val)=>{
    const b=document.createElement('button');
    b.className='fbtn'+(filterMember===val?' active':'');
    b.textContent=label;
    b.onclick=()=>{filterMember=val;renderAll();};
    wrap.appendChild(b);
  };
  mk('ì „ì²´','all');
  MEMBERS.forEach(m=>mk(m,m));
}

function cardMatches(p){
  if(filterMember!=='all'&&p.member!==filterMember)return false;
  const st=getStatus(p.id);
  if(filterStatus==='have'&&st!=='have')return false;
  if(filterStatus==='not'&&st!=='not')return false;
  if(filterSearch){
    const q=filterSearch.toLowerCase();
    if(!p.member.toLowerCase().includes(q)&&!p.version.toLowerCase().includes(q))return false;
  }
  return true;
}

function renderMain(){
  const main=document.getElementById('main');
  main.innerHTML='';
  if(!albums.length){
    main.innerHTML='<div class="empty">ì•„ì§ ì•¨ë²”ì´ ì—†ì–´ìš”!<br><strong>+ ì•¨ë²” ì¶”ê°€</strong> ë²„íŠ¼ìœ¼ë¡œ ì‹œì‘í•´ ë³´ì„¸ìš” ğŸ´<br><span style="font-size:.8rem">ì•¨ë²”ëª…Â·íƒ€ì…Â·ë²„ì „ì„ ì…ë ¥í•˜ë©´ 13ëª… ë©¤ë²„ì˜ í¬ì¹´ ëª©ë¡ì´ ìë™ ìƒì„±ë¼ìš”</span></div>';
    return;
  }
  let anyVisible=false;
  albums.forEach(al=>{
    const pocas=allPocas(al);
    const visible=pocas.filter(p=>cardMatches(p));
    if(!visible.length)return;
    anyVisible=true;
    const haveCount=pocas.filter(p=>getStatus(p.id)==='have').length;
    const sec=document.createElement('div');
    sec.className='album-section';
    sec.innerHTML=`
      <div class="album-header">
        <div class="album-title">${escHtml(al.name)}</div>
        ${al.type?`<div class="album-badge">${escHtml(al.type)}</div>`:''}
        <div class="album-count"><strong>${haveCount}</strong> / ${pocas.length}</div>
        <button class="al-btn photo-btn">ğŸ“· ì‚¬ì§„</button>
        <button class="al-btn del">ì‚­ì œ</button>
      </div>
      <div class="card-grid" id="grid-${al.id}"></div>
    `;
    main.appendChild(sec);
    sec.querySelector('.photo-btn').onclick=()=>openPhotoModal(al);
    sec.querySelector('.del').onclick=()=>deleteAlbum(al.id);
    const grid=sec.querySelector(`#grid-${al.id}`);
    visible.forEach(p=>grid.appendChild(buildCard(p)));
  });
  if(!anyVisible)main.innerHTML='<div class="empty">í•´ë‹¹ ì¡°ê±´ì˜ í¬ì¹´ê°€ ì—†ì–´ìš” ğŸ¥²</div>';
}

function buildCard(p){
  const st=getStatus(p.id);
  const imgUrl=photos[p.id];
  const card=document.createElement('div');
  card.className=`poca-card ${st}`;
  if(imgUrl){
    card.innerHTML=`
      <img class="poca-img" src="${escHtml(imgUrl)}" alt="${escHtml(p.member)}" loading="lazy"
           onerror="this.style.display='none';this.nextElementSibling.style.display='none'">
      <div class="poca-overlay"></div>
      <div class="poca-text"><div class="poca-member">${escHtml(p.member)}</div><div class="poca-version">${escHtml(p.version)}</div></div>
      <div class="poca-check"><svg viewBox="0 0 24 24"><polyline points="4 12 9 17 20 7"/></svg></div>
    `;
  }else{
    card.innerHTML=`
      <div class="poca-text-only"><div class="poca-member">${escHtml(p.member)}</div><div class="poca-version">${escHtml(p.version)}</div></div>
      <div class="poca-check"><svg viewBox="0 0 24 24"><polyline points="4 12 9 17 20 7"/></svg></div>
    `;
  }
  card.addEventListener('click',e=>showCtx(e,p.id,p.member,p.version));
  return card;
}

function updateStats(){
  const have=countHave(),total=countTotal();
  document.getElementById('sn-have').textContent=have;
  document.getElementById('sn-total').textContent=total;
  const pct=total>0?Math.round(have/total*100):0;
  document.getElementById('prog-fill').style.width=pct+'%';
  document.getElementById('prog-pct').textContent=pct+'%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONTEXT MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ctxId=null;
const ctxMenu=document.getElementById('ctx-menu');
function showCtx(e,id,member,version){
  e.stopPropagation();
  ctxId=id;
  document.getElementById('ctx-title').textContent=`${member} Â· ${version}`;
  ctxMenu.querySelectorAll('[data-action]').forEach(el=>el.classList.toggle('cur',el.dataset.action===getStatus(id)));
  const x=Math.min(e.clientX,window.innerWidth-180),y=Math.min(e.clientY,window.innerHeight-140);
  ctxMenu.style.left=x+'px';ctxMenu.style.top=y+'px';
  ctxMenu.classList.add('show');
}
ctxMenu.querySelectorAll('[data-action]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    if(!ctxId)return;
    setStatus(ctxId,btn.dataset.action);
    ctxMenu.classList.remove('show');
    renderMain();updateStats();
  });
});
document.addEventListener('click',e=>{if(!ctxMenu.contains(e.target))ctxMenu.classList.remove('show');});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILTERS UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('[data-status]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    filterStatus=btn.dataset.status;
    document.querySelectorAll('[data-status]').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');renderMain();
  });
});
document.getElementById('search-input').addEventListener('input',e=>{filterSearch=e.target.value.trim();renderMain();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADD ALBUM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let modalVersions=[];
function openAddAlbumModal(){
  modalVersions=[];
  ['al-name','al-type','al-ver-input'].forEach(id=>document.getElementById(id).value='');
  renderVerTags();
  document.getElementById('modal-album').classList.add('show');
  setTimeout(()=>document.getElementById('al-name').focus(),80);
}
function renderVerTags(){
  const wrap=document.getElementById('al-ver-tags');
  wrap.innerHTML='';
  modalVersions.forEach((v,i)=>{
    const tag=document.createElement('div');
    tag.className='tag';
    tag.innerHTML=`${escHtml(v)} <button>Ã—</button>`;
    tag.querySelector('button').onclick=()=>{modalVersions.splice(i,1);renderVerTags();};
    wrap.appendChild(tag);
  });
}
document.getElementById('al-ver-input').addEventListener('keydown',e=>{
  if(e.key==='Enter'){
    e.preventDefault();
    const v=e.target.value.trim();
    if(v&&!modalVersions.includes(v)){modalVersions.push(v);renderVerTags();}
    e.target.value='';
  }
});
document.getElementById('modal-al-cancel').onclick=()=>document.getElementById('modal-album').classList.remove('show');
document.getElementById('modal-al-save').onclick=()=>{
  const name=document.getElementById('al-name').value.trim();
  const type=document.getElementById('al-type').value.trim();
  if(!name){alert('ì•¨ë²”ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”');return;}
  if(!modalVersions.length){alert('ë²„ì „ì„ í•˜ë‚˜ ì´ìƒ ì¶”ê°€í•´ ì£¼ì„¸ìš”\n(ì…ë ¥ í›„ Enter)');return;}
  albums.push({id:'al'+Date.now(),name,type,versions:[...modalVersions]});
  lsSet(K_ALBUMS,albums);
  document.getElementById('modal-album').classList.remove('show');
  renderAll();
};
document.getElementById('btn-add-album').onclick=openAddAlbumModal;
document.getElementById('modal-album').addEventListener('click',e=>{if(e.target===document.getElementById('modal-album'))document.getElementById('modal-album').classList.remove('show');});

function deleteAlbum(id){
  if(!confirm('ì´ ì•¨ë²”ì„ ì‚­ì œí• ê¹Œìš”?\n(ì†Œì¥ ì •ë³´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)'))return;
  const al=albums.find(a=>a.id===id);
  if(al){allPocas(al).forEach(p=>{delete state[p.id];delete photos[p.id];});}
  albums=albums.filter(a=>a.id!==id);
  lsSet(K_ALBUMS,albums);lsSet(K_STATE,state);lsSet(K_PHOTOS,photos);
  renderAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PHOTO MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPhotoModal(al){
  const grid=document.getElementById('photo-edit-grid');
  grid.innerHTML='';
  allPocas(al).forEach(p=>{
    const item=document.createElement('div');
    item.className='photo-item';
    item.innerHTML=`<label>${escHtml(p.member)} Â· ${escHtml(p.version)}</label><input type="text" data-pid="${p.id}" placeholder="ì´ë¯¸ì§€ URL" value="${escHtml(photos[p.id]||'')}">`;
    grid.appendChild(item);
  });
  document.getElementById('modal-photos').classList.add('show');
}
document.getElementById('photo-cancel').onclick=()=>document.getElementById('modal-photos').classList.remove('show');
document.getElementById('photo-save').onclick=()=>{
  document.querySelectorAll('#photo-edit-grid input[data-pid]').forEach(inp=>{
    const url=inp.value.trim();
    if(url)photos[inp.dataset.pid]=url;else delete photos[inp.dataset.pid];
  });
  lsSet(K_PHOTOS,photos);
  document.getElementById('modal-photos').classList.remove('show');
  renderMain();
};
document.getElementById('modal-photos').addEventListener('click',e=>{if(e.target===document.getElementById('modal-photos'))document.getElementById('modal-photos').classList.remove('show');});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BACKUP MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('btn-backup-modal').onclick=()=>{
  document.getElementById('last-backup-label').textContent=lastBackupLabel;
  document.getElementById('modal-backup').classList.add('show');
};
document.getElementById('backup-close').onclick=()=>document.getElementById('modal-backup').classList.remove('show');
document.getElementById('modal-backup').addEventListener('click',e=>{if(e.target===document.getElementById('modal-backup'))document.getElementById('modal-backup').classList.remove('show');});
document.getElementById('btn-manual-export').onclick=()=>exportJSON(false);
document.getElementById('import-file').addEventListener('change',e=>{
  const file=e.target.files[0];if(!file)return;
  importJSON(file);
  e.target.value='';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('btn-reset').onclick=()=>{
  if(confirm('ì†Œì¥ ì •ë³´ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?\n(ì•¨ë²” ëª©ë¡ê³¼ ì‚¬ì§„ URLì€ ìœ ì§€ë©ë‹ˆë‹¤)'))
  {state={};lsSet(K_STATE,state);renderAll();showToast('âœ“','ì´ˆê¸°í™” ì™„ë£Œ');}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT â€” ì•± ì—´ ë•Œë§ˆë‹¤ ìë™ ë°±ì—…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderAll();

// í˜ì´ì§€ ë¡œë“œ í›„ 1ì´ˆ ë’¤ ìë™ ë°±ì—… ì‹¤í–‰
// (ë Œë”ë§ì´ ì™„ë£Œë˜ê³  ì‚¬ìš©ìê°€ ì¤€ë¹„ëœ ë’¤ ë‹¤ìš´ë¡œë“œ)
setTimeout(()=>exportJSON(true), 1000);
</script>
</body>
</html>
